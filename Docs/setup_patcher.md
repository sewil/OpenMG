# Patcher setup
## Server setup (Ubuntu)
### User setup (as root)
Create user:
```
useradd -m -g sudo <username>
passwd <username>
```
Set login shell to bash:
```
usermod -s /bin/bash <username>
```

### Installation (as user)
Install vsftpd:
```
sudo apt update
sudo apt upgrade
sudo apt install vsftpd
```
Create symlinks for config and log file:
```
cd ~
mkdir ftp && cd ftp
ln -s /etc/vsftpd.conf vsftpd.conf
ln -s /var/log/vsftpd.log vsftpd.log
```

### Configuration
Open an editor for the configuration:
```
sudo nano ~/ftp/vsftpd.conf
```
Paste in the following:
```
anonymous_enable=YES
local_enable=YES
write_enable=YES
local_umask=022
chroot_local_user=YES
allow_writeable_chroot=YES
# Set anon root to your home folder
anon_root=/home/<username>
anon_world_readable_only=NO
no_anon_password=YES

# Network
#connect_from_port_20=YES
ftp_data_port=20
listen=NO
listen_ipv6=YES
listen_address=<server-address>
pasv_enable=YES
pasv_min_port=40000
pasv_max_port=50000
# Enable if you need to resolve a domain name rather than an ip
#pasv_addr_resolve=NO
# Bypasses some security for the patcher
pasv_promiscuous=NO
# The native patcher uses this command
port_enable=YES
# Bypasses port security for the patcher
port_promiscuous=YES

# Logging
dirmessage_enable=YES
xferlog_enable=YES
xferlog_std_format=NO
log_ftp_protocol=YES
```
Make sure you have the appropriate permissions for the FTP folder with:
```
sudo chown <username>:<username> -R <ftp-folder>
sudo chmod 755 -R <ftp-folder> 
```

### File structure
The native patcher expects the following file structure in the FTP directory:
- Maple
  - download
    - FullVersion
      - MSSetup.exe - Used if patching fails for some reason.
  - patch
    - notice
      - 000yy.txt - The version changes file.
    - patchdir
        - 000yy
          - 000xxto000yy.patch - The patch file, generated by the PatchCreator (using `make-patches`)
          - NewPatcher.dat - The new patcher to download (renamed from .exe)
          - Version.info - Generated by the PatchCreator, contains the checksum of the new patcher and the version to patch from.

## Server setup (Windows)
1. Download FileZilla server.
2. In the server configuration, go to Rights management -> Users and create a user called "anonymous" which does not require authentication, with read-only access to your FTP folder.
3. In the server listeners protocol, select "Explicit FTP over TLS and insecure plain FTP".
4. In the firewall, open ports 21 and 40000-60000.

## Host configuration
If the host requires it, open the ports 21 and 40000-50000 (passive mode) for inbound IPv6.

## Generating patch files
In the `Patching` directory, create your version folders, named like `v22`, `v23`, and so on. Place in these folders the files for each version that have changed. Also create a notice file in each folder called `000xx.txt` where `xx` is your version, which will contain information for the version changes that will be displayed in the patcher. Then simply run `GeneratePatches.bat` and it will generate the patch files in `Patching\patches` for each version. You should upload `Version.info`, `NewPatcher.dat` and all `.patch` files to the FTP, following the file structure above. The `.exe`-files can be ignored.
